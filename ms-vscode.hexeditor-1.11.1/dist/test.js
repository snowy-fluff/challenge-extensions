"use strict";var zr=Object.create;var K=Object.defineProperty;var Lr=Object.getOwnPropertyDescriptor;var jr=Object.getOwnPropertyNames;var Wr=Object.getPrototypeOf,Gr=Object.prototype.hasOwnProperty;var v=(r,e)=>()=>(r&&(e=r(r=0)),e);var h=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Nr=(r,e)=>{for(var t in e)K(r,t,{get:e[t],enumerable:!0})},kt=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of jr(e))!Gr.call(r,s)&&s!==t&&K(r,s,{get:()=>e[s],enumerable:!(i=Lr(e,s))||i.enumerable});return r};var k=(r,e,t)=>(t=r!=null?zr(Wr(r)):{},kt(e||!r||!r.__esModule?K(t,"default",{value:r,enumerable:!0}):t,r)),Qr=r=>kt(K({},"__esModule",{value:!0}),r);var Be=h(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.ConstantBackoff=void 0;var He=class{constructor(e){this.interval=e}next(){return $r(this.interval)}};ee.ConstantBackoff=He;var $r=r=>({duration:r,next(){return this}})});var Pt=h(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.DelegateBackoff=void 0;var ze=class{constructor(e){this.fn=e}next(e){return Le(this.fn).next(e)}};te.DelegateBackoff=ze;var Le=(r,e,t=0)=>({duration:t,next(i){let s=r(i,e);return typeof s=="number"?Le(r,e,s):Le(r,s.state,s.delay)}})});var je=h(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.decorrelatedJitterGenerator=S.halfJitterGenerator=S.fullJitterGenerator=S.noJitterGenerator=void 0;var Jr=(r=0,e)=>[Math.min(e.maxDelay,e.initialDelay*2**r),r+1];S.noJitterGenerator=Jr;var Vr=(r,e)=>{let[t,i]=(0,S.noJitterGenerator)(r,e);return[Math.floor(Math.random()*t),i]};S.fullJitterGenerator=Vr;var Yr=(r,e)=>{let[t,i]=(0,S.noJitterGenerator)(r,e);return[Math.floor((t+Math.random()*t)/2),i]};S.halfJitterGenerator=Yr;var Zr=4,Xr=1/1.4,Kr=(r,e)=>{let[t,i]=r||[0,0],s=t+Math.random(),o=Math.pow(e.exponent,s)*Math.tanh(Math.sqrt(Zr*s)),n=Math.max(0,o-i);return[Math.min(n*Xr*e.initialDelay,e.maxDelay),[t+1,o]]};S.decorrelatedJitterGenerator=Kr});var Mt=h(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.ExponentialBackoff=void 0;var ei=je(),Ft={generator:ei.decorrelatedJitterGenerator,maxDelay:3e4,exponent:2,initialDelay:128},We=class{constructor(e){this.options=e?{...Ft,...e}:Ft}next(){return qt(this.options).next(void 0)}};re.ExponentialBackoff=We;var qt=(r,e,t=0,i=-1)=>({duration:t,next(){let[s,o]=r.generator(e,r);return qt(r,o,s,i+1)}})});var Bt=h(ie=>{"use strict";Object.defineProperty(ie,"__esModule",{value:!0});ie.IterableBackoff=void 0;var Ge=class{constructor(e){this.durations=e}next(){return Ht(this.durations,0)}};ie.IterableBackoff=Ge;var Ht=(r,e)=>({duration:r[e],next(){return e===r.length-1?this:Ht(r,e+1)}})});var Ne=h(R=>{"use strict";var ti=R&&R.__createBinding||(Object.create?function(r,e,t,i){i===void 0&&(i=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,i,s)}:function(r,e,t,i){i===void 0&&(i=t),r[i]=e[t]}),N=R&&R.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&ti(e,r,t)};Object.defineProperty(R,"__esModule",{value:!0});N(Be(),R);N(Pt(),R);N(Mt(),R);N(je(),R);N(Bt(),R)});var ne=h(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});se.TaskCancelledError=void 0;var Qe=class extends Error{constructor(e="Operation cancelled"){super(e),this.message=e,this.isTaskCancelledError=!0}};se.TaskCancelledError=Qe});var U=h(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.MemorizingEventEmitter=x.EventEmitter=x.onAbort=x.Event=x.noopDisposable=void 0;var zt=ne();x.noopDisposable={dispose:()=>{}};var ri;(function(r){r.once=(e,t)=>{let i=!1,s;return s=e(o=>{t(o),s?s.dispose():i=!0}),i?(s.dispose(),x.noopDisposable):s},r.toPromise=(e,t)=>t?t.aborted?Promise.reject(new zt.TaskCancelledError):new Promise((i,s)=>{let o=(0,x.onAbort)(t)(()=>{n.dispose(),s(new zt.TaskCancelledError)}),n=r.once(e,a=>{o.dispose(),i(a)})}):new Promise(i=>r.once(e,i))})(ri=x.Event||(x.Event={}));var ii=r=>{let e=new Je;if(r.aborted)return e.emit(),e.addListener;let t=()=>{e.emit(),r.removeEventListener("abort",t)};return r.addEventListener("abort",t),e.addListener};x.onAbort=ii;var Q=class{constructor(){this.addListener=e=>this.addListenerInner(e)}get size(){return this.listeners?typeof this.listeners=="function"?1:this.listeners.length:0}emit(e){if(this.listeners)if(typeof this.listeners=="function")this.listeners(e);else for(let t of this.listeners)t(e)}addListenerInner(e){return this.listeners?typeof this.listeners=="function"?this.listeners=[this.listeners,e]:this.listeners.push(e):this.listeners=e,{dispose:()=>this.removeListener(e)}}removeListener(e){if(!this.listeners)return;if(typeof this.listeners=="function"){this.listeners===e&&(this.listeners=void 0);return}let t=this.listeners.indexOf(e);t!==-1&&(this.listeners.length===2?this.listeners=t===0?this.listeners[1]:this.listeners[0]:this.listeners=this.listeners.slice(0,t).concat(this.listeners.slice(t+1)))}};x.EventEmitter=Q;var $e=class extends Q{constructor(){super(...arguments),this.addListener=e=>{let t=this.addListenerInner(e);return this.lastValue&&e(this.lastValue.value),t}}get hasEmitted(){return!!this.lastValue}emit(e){this.lastValue={value:e},super.emit(e)}};x.MemorizingEventEmitter=$e;var Je=class extends Q{constructor(){super(...arguments),this.addListener=e=>this.lastValue?(e(this.lastValue.value),x.noopDisposable):this.addListenerInner(e)}emit(e){this.lastValue={value:e},super.emit(e),this.listeners=void 0}}});var P=h(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.deriveAbortController=D.abortedSignal=D.neverAbortedSignal=void 0;var si=U();D.neverAbortedSignal=new AbortController().signal;var Lt=new AbortController;Lt.abort();D.abortedSignal=Lt.signal;var ni=r=>{let e=new AbortController;if(!r)return e;if(r.aborted&&e.abort(),r!==D.neverAbortedSignal){let t=new WeakRef(e);(0,si.onAbort)(r)(()=>t.deref()?.abort())}return e};D.deriveAbortController=ni});var z=h(B=>{"use strict";Object.defineProperty(B,"__esModule",{value:!0});B.ExecuteWrapper=B.returnOrThrow=void 0;var jt=U(),oi=r=>{if("error"in r)throw r.error;return"success"in r?r.success:r.value};B.returnOrThrow=oi;var ai=()=>{if(typeof performance<"u"){let r=performance.now();return()=>performance.now()-r}else{let r=process.hrtime.bigint();return()=>Number(process.hrtime.bigint()-r)/1e6}},Ve=class r{constructor(e=()=>!1,t=()=>!1){this.errorFilter=e,this.resultFilter=t,this.successEmitter=new jt.EventEmitter,this.failureEmitter=new jt.EventEmitter,this.onSuccess=this.successEmitter.addListener,this.onFailure=this.failureEmitter.addListener}clone(){return new r(this.errorFilter,this.resultFilter)}async invoke(e,...t){let i=this.successEmitter.size||this.failureEmitter.size?ai():null;try{let s=await e(...t);return this.resultFilter(s)?(i&&this.failureEmitter.emit({duration:i(),handled:!0,reason:{value:s}}),{value:s}):(i&&this.successEmitter.emit({duration:i()}),{success:s})}catch(s){let o=s,n=this.errorFilter(o);if(i&&this.failureEmitter.emit({duration:i(),handled:n,reason:{error:o}}),!n)throw o;return{error:o}}}};B.ExecuteWrapper=Ve});var Ze=h(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.BrokenCircuitError=void 0;var Ye=class extends Error{constructor(e="Execution prevented because the circuit breaker is open"){super(e),this.isBrokenCircuitError=!0}};oe.BrokenCircuitError=Ye});var Ke=h(ae=>{"use strict";Object.defineProperty(ae,"__esModule",{value:!0});ae.BulkheadRejectedError=void 0;var Xe=class extends Error{constructor(e,t){super(`Bulkhead capacity exceeded (0/${e} execution slots, 0/${t} available)`),this.isBulkheadRejectedError=!0}};ae.BulkheadRejectedError=Xe});var tt=h(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.IsolatedCircuitError=void 0;var ci=Ze(),et=class extends ci.BrokenCircuitError{constructor(){super("Execution prevented because the circuit breaker is open"),this.isIsolatedCircuitError=!0}};ce.IsolatedCircuitError=et});var le=h(w=>{"use strict";var ui=w&&w.__createBinding||(Object.create?function(r,e,t,i){i===void 0&&(i=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,i,s)}:function(r,e,t,i){i===void 0&&(i=t),r[i]=e[t]}),ue=w&&w.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&ui(e,r,t)};Object.defineProperty(w,"__esModule",{value:!0});w.isTaskCancelledError=w.isIsolatedCircuitError=w.isBulkheadRejectedError=w.isBrokenCircuitError=void 0;ue(Ze(),w);ue(Ke(),w);ue(tt(),w);ue(ne(),w);var li=r=>!!r&&r instanceof Error&&"isBrokenCircuitError"in r;w.isBrokenCircuitError=li;var di=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;w.isBulkheadRejectedError=di;var fi=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;w.isIsolatedCircuitError=fi;var pi=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;w.isTaskCancelledError=pi});var fe=h(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.CircuitBreakerPolicy=F.CircuitState=void 0;var hi=P(),de=U(),Wt=z(),Gt=le(),mi=tt(),y;(function(r){r[r.Closed=0]="Closed",r[r.Open=1]="Open",r[r.HalfOpen=2]="HalfOpen",r[r.Isolated=3]="Isolated"})(y=F.CircuitState||(F.CircuitState={}));var rt=class{constructor(e,t){this.options=e,this.executor=t,this.breakEmitter=new de.EventEmitter,this.resetEmitter=new de.EventEmitter,this.halfOpenEmitter=new de.EventEmitter,this.stateChangeEmitter=new de.EventEmitter,this.innerState={value:y.Closed},this.onBreak=this.breakEmitter.addListener,this.onReset=this.resetEmitter.addListener,this.onHalfOpen=this.halfOpenEmitter.addListener,this.onStateChange=this.stateChangeEmitter.addListener,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}get state(){return this.innerState.value}get lastFailure(){return this.innerLastFailure}isolate(){this.innerState.value!==y.Isolated&&(this.innerState={value:y.Isolated,counters:0},this.breakEmitter.emit({isolated:!0}),this.stateChangeEmitter.emit(y.Isolated)),this.innerState.counters++;let e=!1;return{dispose:()=>{e||(e=!0,this.innerState.value===y.Isolated&&!--this.innerState.counters&&(this.innerState={value:y.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(y.Closed)))}}}async execute(e,t=hi.neverAbortedSignal){let i=this.innerState;switch(i.value){case y.Closed:let s=await this.executor.invoke(e,{signal:t});return"success"in s?this.options.breaker.success(i.value):(this.innerLastFailure=s,this.options.breaker.failure(i.value)&&this.open(s)),(0,Wt.returnOrThrow)(s);case y.HalfOpen:if(await i.test.catch(()=>{}),this.state===y.Closed&&t.aborted)throw new Gt.TaskCancelledError;return this.execute(e);case y.Open:if(Date.now()-i.openedAt<this.options.halfOpenAfter)throw new Gt.BrokenCircuitError;let o=this.halfOpen(e,t);return this.innerState={value:y.HalfOpen,test:o},this.stateChangeEmitter.emit(y.HalfOpen),o;case y.Isolated:throw new mi.IsolatedCircuitError;default:throw new Error(`Unexpected circuit state ${i}`)}}async halfOpen(e,t){this.halfOpenEmitter.emit();try{let i=await this.executor.invoke(e,{signal:t});return"success"in i?(this.options.breaker.success(y.HalfOpen),this.close()):(this.innerLastFailure=i,this.options.breaker.failure(y.HalfOpen),this.open(i)),(0,Wt.returnOrThrow)(i)}catch(i){throw this.close(),i}}open(e){this.state===y.Isolated||this.state===y.Open||(this.innerState={value:y.Open,openedAt:Date.now()},this.breakEmitter.emit(e),this.stateChangeEmitter.emit(y.Open))}close(){this.state===y.HalfOpen&&(this.innerState={value:y.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(y.Closed))}};F.CircuitBreakerPolicy=rt});var Qt=h(pe=>{"use strict";Object.defineProperty(pe,"__esModule",{value:!0});pe.SamplingBreaker=void 0;var Nt=fe(),st=class{constructor({threshold:e,duration:t,minimumRps:i}){if(this.windows=[],this.currentWindow=0,this.currentFailures=0,this.currentSuccesses=0,e<=0||e>=1)throw new RangeError(`SamplingBreaker threshold should be between (0, 1), got ${e}`);this.threshold=e;let s=Math.max(5,Math.ceil(t/1e3));for(let o=0;o<s;o++)this.windows.push({startedAt:0,failures:0,successes:0});this.windowSize=Math.round(t/s),this.duration=this.windowSize*s,i?this.minimumRpms=i/1e3:this.minimumRpms=5/(e*1e3)}success(e){e===Nt.CircuitState.HalfOpen&&this.resetWindows(),this.push(!0)}failure(e){if(this.push(!1),e!==Nt.CircuitState.Closed)return!0;let t=this.currentSuccesses+this.currentFailures;return t<this.duration*this.minimumRpms?!1:this.currentFailures>this.threshold*t}resetWindows(){this.currentFailures=0,this.currentSuccesses=0;for(let e of this.windows)e.failures=0,e.successes=0,e.startedAt=0}rotateWindow(e){let t=(this.currentWindow+1)%this.windows.length;this.currentFailures-=this.windows[t].failures,this.currentSuccesses-=this.windows[t].successes;let i=this.windows[t]={failures:0,successes:0,startedAt:e};return this.currentWindow=t,i}push(e){let t=Date.now(),i=this.windows[this.currentWindow];t-i.startedAt>=this.windowSize&&(i=this.rotateWindow(t)),e?(i.successes++,this.currentSuccesses++):(i.failures++,this.currentFailures++)}};pe.SamplingBreaker=st});var $t=h(he=>{"use strict";Object.defineProperty(he,"__esModule",{value:!0});he.ConsecutiveBreaker=void 0;var nt=class{constructor(e){this.threshold=e,this.count=0}success(){this.count=0}failure(){return++this.count>=this.threshold}};he.ConsecutiveBreaker=nt});var Vt=h(I=>{"use strict";var yi=I&&I.__createBinding||(Object.create?function(r,e,t,i){i===void 0&&(i=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,i,s)}:function(r,e,t,i){i===void 0&&(i=t),r[i]=e[t]}),Jt=I&&I.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&yi(e,r,t)};Object.defineProperty(I,"__esModule",{value:!0});Jt(Qt(),I);Jt($t(),I)});var Yt=h(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.defer=void 0;var vi=()=>{let r,e,t=new Promise((i,s)=>{r=i,e=s});return{resolve:r,reject:e,promise:t}};me.defer=vi});var at=h(ye=>{"use strict";Object.defineProperty(ye,"__esModule",{value:!0});ye.BulkheadPolicy=void 0;var bi=P(),gi=Yt(),wi=U(),xi=z(),Ei=Ke(),Si=le(),ot=class{constructor(e,t){this.capacity=e,this.queueCapacity=t,this.active=0,this.queue=[],this.onRejectEmitter=new wi.EventEmitter,this.executor=new xi.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onReject=this.onRejectEmitter.addListener}get executionSlots(){return this.capacity-this.active}get queueSlots(){return this.queueCapacity-this.queue.length}async execute(e,t=bi.neverAbortedSignal){if(t.aborted)throw new Si.TaskCancelledError;if(this.active<this.capacity){this.active++;try{return await e({signal:t})}finally{this.active--,this.dequeue()}}if(this.queue.length<this.queueCapacity){let{resolve:i,reject:s,promise:o}=(0,gi.defer)();return this.queue.push({signal:t,fn:e,resolve:i,reject:s}),o}throw this.onRejectEmitter.emit(),new Ei.BulkheadRejectedError(this.capacity,this.queueCapacity)}dequeue(){let e=this.queue.shift();e&&Promise.resolve().then(()=>this.execute(e.fn,e.signal)).then(e.resolve).catch(e.reject)}};ye.BulkheadPolicy=ot});var ut=h(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.FallbackPolicy=void 0;var Ri=P(),ct=class{constructor(e,t){this.executor=e,this.value=t,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=Ri.neverAbortedSignal){let i=await this.executor.invoke(e,{signal:t});return"success"in i?i.success:this.value()}};ve.FallbackPolicy=ct});var dt=h(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.NoopPolicy=void 0;var Ai=P(),Zt=z(),lt=class{constructor(){this.executor=new Zt.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=Ai.neverAbortedSignal){return(0,Zt.returnOrThrow)(await this.executor.invoke(e,{signal:t}))}};be.NoopPolicy=lt});var pt=h(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});ge.RetryPolicy=void 0;var Di=Be(),_i=P(),Xt=U(),Ui=(r,e)=>new Promise(t=>{let i=setTimeout(t,r);e&&i.unref()}),ft=class r{constructor(e,t){this.options=e,this.executor=t,this.onGiveUpEmitter=new Xt.EventEmitter,this.onRetryEmitter=new Xt.EventEmitter,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onRetry=this.onRetryEmitter.addListener,this.onGiveUp=this.onGiveUpEmitter.addListener}dangerouslyUnref(){return new r({...this.options,unref:!0},this.executor.clone())}async execute(e,t=_i.neverAbortedSignal){let i=this.options.backoff||new Di.ConstantBackoff(0),s;for(let o=0;;o++){let n=await this.executor.invoke(e,{attempt:o,signal:t});if("success"in n)return n.success;if(!t.aborted&&o<this.options.maxAttempts){let a={attempt:o+1,signal:t,result:n};s=s?s.next(a):i.next(a);let c=s.duration,l=Ui(c,!!this.options.unref);this.onRetryEmitter.emit({...n,delay:c}),await l;continue}if(this.onGiveUpEmitter.emit(n),"error"in n)throw n.error;return n.value}}};ge.RetryPolicy=ft});var vt=h(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.TimeoutPolicy=q.TimeoutStrategy=void 0;var Ii=P(),ht=U(),mt=z(),Oi=ne(),Kt;(function(r){r.Cooperative="optimistic",r.Aggressive="aggressive"})(Kt=q.TimeoutStrategy||(q.TimeoutStrategy={}));var yt=class r{constructor(e,t,i=new mt.ExecuteWrapper,s=!1){this.duration=e,this.options=t,this.executor=i,this.unref=s,this.timeoutEmitter=new ht.EventEmitter,this.onTimeout=this.timeoutEmitter.addListener,this.onFailure=this.executor.onFailure,this.onSuccess=this.executor.onSuccess}dangerouslyUnref(){return new r(this.duration,this.options,this.executor,!0)}async execute(e,t){let i=(0,Ii.deriveAbortController)(t),s=setTimeout(()=>i.abort(),this.duration);this.unref&&s.unref();let o={signal:i.signal},n=(0,ht.onAbort)(i.signal),a=n(()=>this.timeoutEmitter.emit());try{return this.options.strategy===Kt.Cooperative?(0,mt.returnOrThrow)(await this.executor.invoke(e,o,i.signal)):await this.executor.invoke(async()=>Promise.race([Promise.resolve(e(o,i.signal)),ht.Event.toPromise(n).then(()=>{throw new Oi.TaskCancelledError(`Operation timed out after ${this.duration}ms`)})])).then(mt.returnOrThrow)}finally{a.dispose(),this.options.abortOnReturn!==!1&&i.abort(),clearTimeout(s)}}};q.TimeoutPolicy=yt});var er=h(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.fallback=d.circuitBreaker=d.retry=d.wrap=d.timeout=d.usePolicy=d.bulkhead=d.handleWhenResult=d.handleResultType=d.handleWhen=d.handleType=d.handleAll=d.noop=d.Policy=void 0;var Ti=Ne(),Ci=at(),ki=fe(),bt=z(),Pi=ut(),Fi=dt(),qi=pt(),Mi=vt(),we=(r,e)=>e?t=>t instanceof r&&e(t):t=>t instanceof r,Hi=()=>!0,$=()=>!1,O=class r{constructor(e){this.options=e}orType(e,t){let i=we(e,t);return new r({...this.options,errorFilter:s=>this.options.errorFilter(s)||i(s)})}orWhen(e){return new r({...this.options,errorFilter:t=>this.options.errorFilter(t)||e(t)})}orWhenResult(e){return new r({...this.options,resultFilter:t=>this.options.resultFilter(t)||e(t)})}orResultType(e,t){let i=we(e,t);return new r({...this.options,resultFilter:s=>this.options.resultFilter(s)||i(s)})}};d.Policy=O;d.noop=new Fi.NoopPolicy;d.handleAll=new O({errorFilter:Hi,resultFilter:$});function Bi(r,e){return new O({errorFilter:we(r,e),resultFilter:$})}d.handleType=Bi;function zi(r){return new O({errorFilter:r,resultFilter:$})}d.handleWhen=zi;function Li(r,e){return new O({errorFilter:$,resultFilter:we(r,e)})}d.handleResultType=Li;function ji(r){return new O({errorFilter:$,resultFilter:r})}d.handleWhenResult=ji;function Wi(r,e=0){return new Ci.BulkheadPolicy(r,e)}d.bulkhead=Wi;function Gi(r){return(e,t,i)=>{let s=i.value;if(typeof s!="function")throw new Error(`Can only decorate functions with @cockatiel, got ${typeof s}`);i.value=function(...o){let n=o[o.length-1]instanceof AbortSignal?o.pop():void 0;return r.execute(a=>s.apply(this,[...o,a]),n)}}}d.usePolicy=Gi;function Ni(r,e){return new Mi.TimeoutPolicy(r,typeof e=="string"?{strategy:e}:e)}d.timeout=Ni;function Qi(...r){return{_altReturn:void 0,onFailure:r[0].onFailure,onSuccess:r[0].onSuccess,wrapped:r,execute(e,t){let i=(s,o)=>o===r.length?e(s):r[o].execute(n=>i({...s,...n},o+1),s.signal);return Promise.resolve(i({signal:t},0))}}}d.wrap=Qi;function $i(r,e){return new qi.RetryPolicy({backoff:e.backoff||new Ti.ConstantBackoff(0),maxAttempts:e.maxAttempts??1/0},new bt.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter))}d.retry=$i;function Ji(r,e){return new ki.CircuitBreakerPolicy(e,new bt.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter))}d.circuitBreaker=Ji;function Vi(r,e){return new Pi.FallbackPolicy(new bt.ExecuteWrapper(r.options.errorFilter,r.options.resultFilter),typeof e=="function"?e:()=>e)}d.fallback=Vi});var gt=h(g=>{"use strict";var Yi=g&&g.__createBinding||(Object.create?function(r,e,t,i){i===void 0&&(i=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,i,s)}:function(r,e,t,i){i===void 0&&(i=t),r[i]=e[t]}),A=g&&g.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Yi(e,r,t)};Object.defineProperty(g,"__esModule",{value:!0});g.EventEmitter=g.Event=void 0;A(Ne(),g);A(Vt(),g);A(at(),g);A(fe(),g);var tr=U();Object.defineProperty(g,"Event",{enumerable:!0,get:function(){return tr.Event}});Object.defineProperty(g,"EventEmitter",{enumerable:!0,get:function(){return tr.EventEmitter}});A(le(),g);A(ut(),g);A(dt(),g);A(er(),g);A(pt(),g);A(vt(),g)});var rr,ir=v(()=>{"use strict";rr=r=>(e,t)=>{let i,s=0,o=t.length-1;for(;s<=o;)i=Math.floor((s+o)/2),r(t[i])>=e?o=i-1:s=i+1;return s}});var xe,Ee,sr=v(()=>{"use strict";xe=Symbol("unset"),Ee=r=>{let e=xe,t=()=>(e===xe&&(e=r()),e);return t.getValue=()=>e===xe?void 0:e,t.forget=()=>{e=xe},t}});async function*nr(r,e,t=0,i=1024){let s=new Uint8Array(i);for(let o=0;o<e.length;o++){let n=e[o];if(n.op===1)continue;if(n.op===3){let l=n.offset+n.length-t;if(l<=0)continue;let f=l<n.length?s.fill(0,-l).subarray(-l):s.fill(0,-n.length).subarray(-n.length);f.length>0&&(yield f);continue}if(n.op===2){let l=n.offset+n.value.length-t;if(l<=0)continue;let f=l<n.value.length?n.value.subarray(-l):n.value;f.length>0&&(yield f);continue}let a=n.roffset+(o+1<e.length?e[o+1].offset:1/0)-n.offset,c=n.roffset+Math.max(0,t-n.offset);for(;c<a;){let l=await r.read(c,s.subarray(0,Math.min(s.length,a-c)));if(l===0)break;yield s.subarray(0,l),c+=l}}}var ar,Zi,_,or,L=v(()=>{"use strict";ar=k(gt());ir();sr();Zi=r=>r.op===0?{...r,op:1,previous:r.value}:r.op===1?{...r,op:0,value:r.previous}:{...r,value:r.previous,previous:r.value},_=class{constructor(e){this.saveGuard=(0,ar.bulkhead)(1,1/0);this._unsavedEditIndex=0;this.getSizeInner=Ee(()=>this.accessor.getSize());this.getAllEditTimeline=Ee(()=>or(this._edits));this.getUnsavedEditTimeline=Ee(()=>or(this._edits.slice(this._unsavedEditIndex)));this._edits=e.edits?e.edits.saved.concat(e.edits.unsaved):[],this._unsavedEditIndex=e.edits?.saved.length??0,this.supportsLengthChanges=e.supportsLengthChanges,this.isFiniteSize=e.isFiniteSize,this.accessor=e.accessor,this.pageSize=e.accessor.pageSize}get uri(){return this.accessor.uri}get isReadonly(){return!!this.accessor.isReadonly}async size(){if(!this.isFiniteSize)return;let e=await this.getSizeInner();if(e!==void 0)return e}async sizeWithEdits(){if(!this.isFiniteSize)return;let e=await this.getSizeInner();if(e===void 0)return;let{sizeDelta:t}=this.getUnsavedEditTimeline();return e+t}get edits(){return this._edits}get unsavedEdits(){return this._edits.slice(this.unsavedEditIndex)}get unsavedEditIndex(){return this._unsavedEditIndex}get isSynced(){return this.unsavedEditIndex===this.edits.length}readInto(e,t){return this.accessor.read(e,t)}readWithAllEdits(e=0,t=128*1024){return nr(this.accessor,this.getAllEditTimeline().ranges,e,t)}readWithUnsavedEdits(e=0,t=128*1024){return nr(this.accessor,this.getUnsavedEditTimeline().ranges,e,t)}save(){let e=this._edits.slice(this.unsavedEditIndex);return e.length===0?Promise.resolve():this.saveGuard.execute(async()=>{e.some(t=>t.op!==2||t.previous.length!==t.value.length)?await this.accessor.writeStream(this.readWithUnsavedEdits()):await this.accessor.writeBulk(e.map(t=>({offset:t.offset,data:t.value}))),this._unsavedEditIndex+=e.length,this.getUnsavedEditTimeline.forget(),this.getSizeInner.forget()})}revert(){this._unsavedEditIndex=0,this._edits=[],this.accessor.invalidate?.(),this.getAllEditTimeline.forget(),this.getUnsavedEditTimeline.forget(),this.getSizeInner.forget()}makeEdits(e){let t=this._edits.length;return this._edits.push(...e),this.getAllEditTimeline.forget(),this.getUnsavedEditTimeline.forget(),{undo:()=>(this.unsavedEditIndex<=t?this._edits.splice(t,e.length):this._edits.push(...e.map(Zi)),this.getAllEditTimeline.forget(),this.getUnsavedEditTimeline.forget(),this._edits),redo:()=>(this._edits.push(...e),this.getAllEditTimeline.forget(),this.getUnsavedEditTimeline.forget(),this._edits)}}dispose(){this.accessor.dispose()}};or=r=>{let e=[{op:0,editIndex:-1,roffset:0,offset:0}],t=(n,a,c)=>a.op===0?{before:{op:0,editIndex:n,roffset:a.roffset,offset:a.offset},after:{op:0,editIndex:n,roffset:a.roffset+c,offset:a.offset+c}}:a.op===1?{before:{op:1,editIndex:n,offset:a.offset},after:{op:1,editIndex:n,offset:a.offset+c}}:a.op===2?{before:{op:2,editIndex:n,offset:a.offset,value:a.value.subarray(0,c)},after:{op:2,editIndex:n,offset:a.offset+c,value:a.value.subarray(c)}}:{before:{op:3,editIndex:n,offset:a.offset,length:c},after:{op:3,editIndex:n,offset:a.offset+c,length:a.length-c}},i=rr(n=>n.offset),s=0,o=(n,a)=>{for(s+=a;n<e.length;n++)e[n].offset+=a};for(let n=0;n<r.length;n++){let a=r[n],c=i(a.offset,e);(c===e.length||e[c].offset>a.offset)&&c--;let l=e[c];if(a.op===0||a.op===3){let{before:f,after:p}=t(n,l,a.offset-l.offset);e.splice(c,1,f,a.op===0?{op:2,editIndex:n,offset:a.offset,value:a.value}:{op:3,editIndex:n,offset:a.offset,length:a.length},p),o(c+2,a.op===0?a.value.length:a.length)}else if(a.op===1||a.op===2){let{before:f}=t(n,l,a.offset-l.offset),p=i(a.offset+a.previous.length,e);(p===e.length||e[p].offset>a.offset)&&p--;let{after:b}=t(n,e[p],a.offset+a.previous.length-e[p].offset);e.splice(c,p-c+1,f,a.op===2?{op:2,editIndex:n,offset:a.offset,value:a.value}:{op:1,editIndex:n,offset:a.offset},b),o(c+2,(a.op===2?a.value.length:0)-a.previous.length)}}return{ranges:e,sizeDelta:s}}});var Xi,Ki,Ae,rn,sn,es,J,Se,ts,Re,cr,rs,lr,is,ss,ur,dr,ns,os,as,fr,cs,pr=v(()=>{"use strict";Xi=typeof atob=="function",Ki=typeof btoa=="function",Ae=typeof Buffer=="function",rn=typeof TextDecoder=="function"?new TextDecoder:void 0,sn=typeof TextEncoder=="function"?new TextEncoder:void 0,es="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",J=Array.prototype.slice.call(es),Se=(r=>{let e={};return r.forEach((t,i)=>e[t]=i),e})(J),ts=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Re=String.fromCharCode.bind(String),cr=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):(r,e=t=>t)=>new Uint8Array(Array.prototype.slice.call(r,0).map(e)),rs=r=>r.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),lr=r=>r.replace(/[^A-Za-z0-9\+\/]/g,""),is=r=>{let e,t,i,s,o="",n=r.length%3;for(let a=0;a<r.length;){if((t=r.charCodeAt(a++))>255||(i=r.charCodeAt(a++))>255||(s=r.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=t<<16|i<<8|s,o+=J[e>>18&63]+J[e>>12&63]+J[e>>6&63]+J[e&63]}return n?o.slice(0,n-3)+"===".substring(n):o},ss=Ki?r=>btoa(r):Ae?r=>Buffer.from(r,"binary").toString("base64"):is,ur=Ae?r=>Buffer.from(r).toString("base64"):r=>{let t=[];for(let i=0,s=r.length;i<s;i+=4096)t.push(Re.apply(null,r.subarray(i,i+4096)));return ss(t.join(""))},dr=(r,e=!1)=>e?rs(ur(r)):ur(r),ns=r=>{if(r=r.replace(/\s+/g,""),!ts.test(r))throw new TypeError("malformed base64.");r+="==".slice(2-(r.length&3));let e,t="",i,s;for(let o=0;o<r.length;)e=Se[r.charAt(o++)]<<18|Se[r.charAt(o++)]<<12|(i=Se[r.charAt(o++)])<<6|(s=Se[r.charAt(o++)]),t+=i===64?Re(e>>16&255):s===64?Re(e>>16&255,e>>8&255):Re(e>>16&255,e>>8&255,e&255);return t},os=Xi?r=>atob(lr(r)):Ae?r=>Buffer.from(r,"base64").toString("binary"):ns,as=Ae?r=>cr(Buffer.from(r,"base64")):r=>cr(os(r),e=>e.charCodeAt(0)),fr=r=>as(cs(r)),cs=r=>lr(r.replace(/[-_]/g,e=>e=="-"?"+":"/"))});var wt,ls,ds,M,xt=v(()=>{"use strict";pr();wt=k(require("vscode")),ls=new TextEncoder,ds=new TextDecoder,M=class{constructor(e){this.uri=e}async write(e){let t=JSON.stringify(e,(i,s)=>s instanceof Uint8Array?{$u8:dr(s)}:s);await wt.workspace.fs.writeFile(this.uri,ls.encode(t))}async read(){let e;try{e=ds.decode(await wt.workspace.fs.readFile(this.uri))}catch{return[]}return JSON.parse(e,(t,i)=>i&&typeof i=="object"&&"$u8"in i?fr(i.$u8):i)}}});var j,m,V,Et,fs,hr,St,De,Rt,At,Dt,_t=v(()=>{"use strict";j=k(gt()),m=k(require("vscode")),V=async(r,e)=>{if(r.scheme==="untitled")return new Rt(r,e??new Uint8Array);if(r.scheme==="vscode-debug-memory"){let{permissions:t=0}=await m.workspace.fs.stat(r);return new At(r,!!(t&m.FilePermission.Readonly))}if(r.scheme==="file"||r.scheme==="hexdiff")try{let t=require("fs"),i=require("os"),s=await t.promises.stat(r.fsPath),{uid:o,gid:n}=i.userInfo(),a=o===-1||o===s.uid?!(s.mode&128):n===s.gid?!(s.mode&16):!(s.mode&2);if(s.isFile())return new St(r,r.scheme==="hexdiff"?!0:a,t)}catch{}return new De(r)},Et=class{constructor(e,t,i){this.path=e;this.flags=t;this._fs=i;this.borrowQueue=[];this.disposed=!1}borrow(e){return this.disposed?Promise.reject(new Error("FileHandle was disposed")):new Promise((t,i)=>{this.borrowQueue.push(async s=>{if(s instanceof Error)return i(s);try{t(await e(s))}catch(o){i(o)}}),this.borrowQueue.length===1&&this.process()})}dispose(){this.disposed=!0,this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.rejectAll(new Error("FileHandle was disposed"))}async close(){await this.handle?.close(),this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout)}rejectAll(e){for(;this.borrowQueue.length;)this.borrowQueue.pop()(e)}async process(){for(this.disposeTimeout&&clearTimeout(this.disposeTimeout);this.borrowQueue.length;){if(!this.handle)try{this.handle=await this._fs.promises.open(this.path,this.flags|this._fs.constants.O_CREAT)}catch(e){return this.rejectAll(e)}await this.borrowQueue[0]?.(this.handle),this.borrowQueue.shift()}this.handle&&(this.disposeTimeout=setTimeout(()=>{this.handle?.close(),this.handle=void 0},1e3))}},fs=(0,j.retry)((0,j.handleWhen)(r=>r.code==="ENOENT"),{maxAttempts:50,backoff:new j.ConstantBackoff(50)}),hr=128*1024,St=class{constructor(e,t,i){this.fs=i;this.supportsIncremetalAccess=!0;this.pageSize=hr;this.uri=e.toString(),this.isReadonly=t,this.handle=new Et(e.fsPath,t?i.constants.O_RDONLY:i.constants.O_RDWR,i)}watch(e,t){return Dt(this.uri,e,t)}async getSize(){return this.handle.borrow(async e=>(await e.stat()).size)}async read(e,t){return this.handle.borrow(async i=>{let{bytesRead:s}=await i.read(t,0,t.byteLength,e);return s})}writeBulk(e){return this.handle.borrow(async t=>Promise.all(e.map(({data:i,offset:s})=>t.write(i,0,i.byteLength,s))))}async writeStream(e,t){let i=`${this.handle.path}.tmp`,s=await this.fs.promises.open(i,this.fs.constants.O_WRONLY|this.fs.constants.O_CREAT|this.fs.constants.O_TRUNC);try{let o=0;for await(let n of e){if(t?.isCancellationRequested)return;await s.write(n,0,n.byteLength,o),o+=n.byteLength}}finally{await s.close()}return await this.handle.borrow(async()=>{await this.handle.close(),await fs.execute(()=>this.fs.promises.rename(i,this.handle.path))}),this.handle.borrow(async o=>{if(t?.isCancellationRequested)return;let n=0;for await(let a of e){if(t?.isCancellationRequested)return;await o.write(a,0,a.byteLength,n),n+=a.byteLength}})}dispose(){this.handle.dispose()}},De=class{constructor(e){this.pageSize=hr;this.uri=e.toString(),this.fsPath=e.fsPath,this.isReadonly=m.workspace.fs.isWritableFileSystem(this.uri)===!1}watch(e,t){return Dt(this.uri,e,t)}async getSize(){return(await m.workspace.fs.stat(m.Uri.parse(this.uri))).size}async read(e,t){let i=await this.getContents(),s=Math.min(t.length,i.length-e);return t.set(i.subarray(e,s+e)),s}async writeStream(e,t){let i=0,s=[];for await(let a of e){if(t?.isCancellationRequested)throw new m.CancellationError;s.push(a),i+=a.length}let o=new Uint8Array(i),n=0;for(let a of s)o.set(a,n),n+=a.length;await m.workspace.fs.writeFile(m.Uri.parse(this.uri),o)}async writeBulk(e){let t=await this.getContents();for(let{data:i,offset:s}of e)t.set(i,s);return m.workspace.fs.writeFile(m.Uri.parse(this.uri),t)}invalidate(){this.contents=void 0}dispose(){this.contents=void 0}getContents(){return this.contents??=m.workspace.fs.readFile(m.Uri.parse(this.uri)),this.contents}},Rt=class extends De{constructor(e,t){super(e),this.contents=t}getSize(){return Promise.resolve(this.contents.byteLength)}},At=class{constructor(e,t){this.isReadonly=t;this.supportsIncremetalAccess=!0;this.pageSize=4*1024;this.uri=e.toString()}watch(e,t){return Dt(this.uri,e,t)}async getSize(){}async read(e,t){let i=await m.workspace.fs.readFile(this.referenceRange(e,e+t.length)),s=Math.min(t.length,i.length);return t.set(i.subarray(0,s)),s}async writeStream(){throw new Error("Not supported")}async writeBulk(e){await Promise.all(e.map(t=>m.workspace.fs.writeFile(this.referenceRange(t.offset,t.offset+t.data.length),t.data)))}referenceRange(e,t){return m.Uri.parse(this.uri).with({query:`?range=${e}:${t}`})}invalidate(){}dispose(){}},Dt=(r,e,t)=>{let i=r.split("/"),s=i.pop(),o=new m.RelativePattern(m.Uri.parse(i.join("/")),s),n=m.workspace.createFileSystemWatcher(o),a=n.onDidChange(e),c=n.onDidDelete(t);return new m.Disposable(()=>{a.dispose(),c.dispose(),n.dispose()})}});var _e,It,mr,yr,vr,Ut,Ot,Ue,br,Ie=v(()=>{"use strict";_e=require("crypto"),It=require("fs"),mr=require("os"),yr=require("path"),vr=k(require("vscode"));_t();Ut=[],Ot=async r=>{let e=(0,yr.join)((0,mr.tmpdir)(),`vscode-hexeditor-test-${(0,_e.randomBytes)(8).toString("hex")}.bin`);return Ut.push(e),r&&await It.promises.writeFile(e,r),vr.Uri.file(e)},Ue=async r=>V(await Ot(r));afterEach(async()=>{await Promise.all(Ut.map(It.promises.unlink)),Ut=[]});br=r=>()=>{let e=(0,_e.createHash)("sha256").update(r).digest();return r=e,e.readUInt32BE()/4294967295}});var ps={};var gr,wr=v(()=>{"use strict";gr=require("chai");L();xt();Ie();describe("Backup",()=>{let r=[{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}];it("round trips",async()=>{let e=new M(await Ot());await e.write(r),(0,gr.expect)(await e.read()).to.deep.equal(r)})})});function hs(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function ms(r,e=0){e=Er(149417,e);for(let t=0,i=r.length;t<i;t++)e=Er(r[t],e);return e}function Er(r,e){return(e<<5)-e+r|0}var xr,W,Tt=v(()=>{"use strict";xr=r=>typeof r=="function"?r():r,W=class{constructor(){this.table=new Map}set(e,t){let i=ms(e),s=this.table.get(i);if(!s){let n={buf:e,value:xr(t)};return this.table.set(i,[n]),n.value}for(let n of s)if(hs(n.buf,e))return n.value;let o={buf:e,value:xr(t)};return s.push(o),o.value}*entries(){for(let e of this.table.values())for(let{buf:t,value:i}of e)yield[t,i]}*keys(){for(let e of this.table.values())for(let{buf:t}of e)yield t}*values(){for(let e of this.table.values())for(let{value:t}of e)yield t}}});var Sr,Rr,Ar=v(()=>{"use strict";L();Tt();Sr=r=>{let e=0,t=new W,i=n=>({offset:t.set(n,()=>{let c=e;return e+=n.length,c}),len:n.length}),s=[];for(let n of r)n.op===0?s.push({...n,value:i(n.value)}):n.op===1?s.push({...n,previous:i(n.previous)}):s.push({...n,previous:i(n.previous),value:i(n.value)});let o=new Uint8Array(e);for(let[n,a]of t.entries())o.set(n,a);return{data:o,edits:s}},Rr=({edits:r,data:e})=>{let t=({offset:i,len:s})=>e.slice(i,i+s);return r.map(i=>i.op===0?{...i,value:t(i.value)}:i.op===1?{...i,previous:t(i.previous)}:{...i,previous:t(i.previous),value:t(i.value)})}});var ys={};var G,Dr=v(()=>{"use strict";G=require("chai");L();Ar();Ie();describe("HexDocumentModel",()=>{let r=[0,1,2,3,4,5,6,7,8,9],e;beforeEach(async()=>{e=new _({accessor:await Ue(new Uint8Array(r)),supportsLengthChanges:!1,isFiniteSize:!0})}),describe("edit timeline",()=>{it("keeps offsets in replacements",()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]);let t=e.getAllEditTimeline();(0,G.expect)(t).to.deep.equal({sizeDelta:-4,ranges:[{op:0,editIndex:1,roffset:0,offset:0},{op:2,editIndex:1,offset:1,value:new Uint8Array([11])},{op:0,editIndex:1,roffset:4,offset:2},{op:2,editIndex:0,offset:4,value:new Uint8Array([16])},{op:0,editIndex:0,roffset:9,offset:5}]})})}),describe("serialization",()=>{it("round trips",()=>{let t=[{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])},{op:1,offset:3,previous:new Uint8Array([3,4,5])}],i=Sr(t);(0,G.expect)(Rr(i)).to.deep.equal(t),(0,G.expect)(i.data.length).to.equal(9)})}),describe("edit reading",()=>{let t=async i=>{let s=e.isSynced?"after saving":"before saving";for(let o=0;o<i.length;o++){let n=new Uint8Array;for await(let a of e.readWithUnsavedEdits(o))n=Buffer.concat([n,a]);(0,G.expect)(n).to.deep.equal(Buffer.from(i.subarray(o)),`expected to be equal at offset ${o} ${s}`)}(0,G.expect)(await e.sizeWithEdits()).to.equal(i.length,`model size does not match expected size ${s}`)};it("reads file verbatim",async()=>{await t(new Uint8Array(r)),await e.save(),await t(new Uint8Array(r))}),it("reads with a simple insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])}]),await t(new Uint8Array([0,1,10,11,12,2,3,4,5,6,7,8,9])),await e.save(),await t(new Uint8Array([0,1,10,11,12,2,3,4,5,6,7,8,9]))}),it("reads with a simple delete",async()=>{e.makeEdits([{op:1,offset:2,previous:new Uint8Array([2,3,4])}]),await t(new Uint8Array([0,1,5,6,7,8,9])),await e.save(),await t(new Uint8Array([0,1,5,6,7,8,9]))}),it("reads with a simple replace",async()=>{e.makeEdits([{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,1,10,11,12,5,6,7,8,9])),await e.save(),await t(new Uint8Array([0,1,10,11,12,5,6,7,8,9]))}),it("replaces at beginning",async()=>{e.makeEdits([{op:2,offset:0,value:new Uint8Array([10,11,12]),previous:new Uint8Array([0,1,2])}]),await t(new Uint8Array([10,11,12,3,4,5,6,7,8,9])),await e.save(),await t(new Uint8Array([10,11,12,3,4,5,6,7,8,9]))}),it("makes random replacements",async function(){this.timeout(1e4);let i=new Uint8Array(r),s=br("vs code!"),o=`- [${i.join(", ")}]
`,n=0;for(let a=0;a<1e3;a++){let c=Math.floor(s()*i.length),l=Math.floor((i.length-c)*s()),f=new Uint8Array(l),p=new Uint8Array(l);for(let b=0;b<l;b++)p[b]=i[c+b],f[b]=i[c+b]=n++&255;o+=`- arr.set(${c}, [${f.join(", ")}]) -> [${i.join(", ")}]
`,e.makeEdits([{op:2,offset:c,value:f,previous:p}]);try{await t(i),await e.save(),await t(i)}catch(b){throw console.log(o),b}}}),it("works with multiple replacements",async()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,11,4,5,16,9])),await e.save(),await t(new Uint8Array([0,11,4,5,16,9]))}),it("overlaps replace on delete",async()=>{e.makeEdits([{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}]),await t(new Uint8Array([0,10,11,12,7,8,9])),await e.save(),await t(new Uint8Array([0,10,11,12,7,8,9]))}),it("overlaps replace on insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:1,value:new Uint8Array([20,21,22]),previous:new Uint8Array([1,10,11])}]),await t(new Uint8Array([0,20,21,22,12,2,3,4,5,6,7,8,9])),await e.save(),await t(new Uint8Array([0,20,21,22,12,2,3,4,5,6,7,8,9]))}),it("delete overlaps multiple",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:1,offset:1,previous:new Uint8Array([1,10,11,12,2,3])}]),await t(new Uint8Array([0,4,5,6,7,8,9])),await e.save(),await t(new Uint8Array([0,4,5,6,7,8,9]))})})})});function _r(r){let e={};if(r){let t=(r[0]==="?"?r.substr(1):r).split("&");for(let i of t){let s=i.split("="),o=s.shift();if(o){let n=s.join("=");o==="side"?(n==="modified"||n==="original"||n===void 0)&&(e.side=n):e[o]=n}}}return e}var Ur=v(()=>{"use strict"});function vs(r){for(;r.length;){let e=r.pop();e&&e.dispose()}}var Te,Ir=v(()=>{"use strict";Te=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,vs(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}}});var Or=v(()=>{"use strict"});var Ce,Tr=v(()=>{"use strict";Or();Ce=class{start(e,t){this._request?.dispose(),this._request=t,(async()=>{for await(let i of t.search())e.sendEvent({type:2,data:i})})()}cancel(){this._request?.dispose(),this._request=void 0}}});var E,ke,Cr=v(()=>{"use strict";E=k(require("vscode"));L();Ur();xt();Ir();_t();Tr();ke=class r extends Te{constructor(t,i,s,o){super();this.model=t;this.isLargeFile=i;this.baseAddress=s;this.diffModel=o;this.lastSave=0;this._selectionState={selected:0};this._editMode=0;this._hoverState=void 0;this.searchProvider=new Ce;this._onDidDispose=this._register(new E.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidChangeSelectionState=this._register(new E.EventEmitter);this.onDidChangeSelectionState=this._onDidChangeSelectionState.event;this._onDidChangeEditMode=this._register(new E.EventEmitter);this.onDidChangeEditMode=this._onDidChangeEditMode.event;this._onDidChangeHoverState=this._register(new E.EventEmitter);this.onDidChangeHoverState=this._onDidChangeHoverState.event;this._onDidRevert=this._register(new E.EventEmitter);this.onDidRevert=this._onDidRevert.event}static async create(t,{backupId:i,untitledDocumentData:s},o,n){let a=await V(t,s),c=new _({accessor:a,isFiniteSize:!0,supportsLengthChanges:!0,edits:i?{unsaved:await new M(E.Uri.parse(i)).read(),saved:[]}:void 0}),l=_r(t.query),f=l.baseAddress?r.parseHexOrDecInt(l.baseAddress):0,p=await a.getSize();o.sendTelemetryEvent("fileOpen",{},{fileSize:p??0});let b=E.workspace.getConfiguration().get("hexeditor.maxFileSize")*1e6,X=!i&&!a.supportsIncremetalAccess&&(p??0)>b,Me=l.side&&n?await n.setModel(l.side,c).build():void 0;return{document:new r(c,X,f,Me),accessor:a}}get pageSize(){return this.model.pageSize}get isReadonly(){return this.model.isReadonly}get uri(){return E.Uri.parse(this.model.uri)}async readDecorators(){if(this.diffModel)try{return await this.diffModel.computeDecorators(this.uri)}catch(t){E.window.showErrorMessage(t instanceof Error?t.message:E.l10n.t("Unknown Error in HexEditor Diff"))}return[]}readWithUnsavedEdits(t){return this.model.readWithUnsavedEdits(t)}async readBufferWithEdits(t,i){let s=new Uint8Array(i),o=0;for await(let n of this.model.readWithUnsavedEdits(t)){let a=Math.min(n.length,s.length-o);if(s.set(n.subarray(0,a),o),o+=a,o===i)return s}return s.slice(0,o)}async readBuffer(t,i){let s=new Uint8Array(i),o=await this.model.readInto(t,s);return o===i?s:s.slice(0,o)}dispose(){this._onDidDispose.fire(),this.model.dispose(),super.dispose()}get selectionState(){return this._selectionState}set selectionState(t){this._selectionState=t,this._onDidChangeSelectionState.fire(t)}get editMode(){return this._editMode}set editMode(t){this._editMode=t,this._onDidChangeEditMode.fire(t)}get hoverState(){return this._hoverState}set hoverState(t){this._hoverState=t,this._onDidChangeHoverState.fire(t)}get isSynced(){return this.model.isSynced}get edits(){return this.model.edits}get unsavedEditIndex(){return this.model.unsavedEditIndex}makeEdits(t){return this.model.makeEdits(t)}insert(t,i){return this.model.makeEdits([{op:0,offset:t,value:i}])}async replace(t,i){let s=await this.readBufferWithEdits(t,i.length);return s.length===i.length?this.makeEdits([{op:2,offset:t,value:i,previous:s}]):this.makeEdits([{op:2,offset:t,value:i.subarray(0,s.length),previous:s},{op:0,offset:t+s.length,value:i.subarray(s.length)}])}size(){return this.model.size()}async save(t){this.lastSave=Date.now(),await this.model.save(),this.lastSave=Date.now()}async saveAs(t,i){if(i&&i.isCancellationRequested)return;if(!this.model.isFiniteSize)throw new Error("Cannot save a document without a finite size");let s=await V(t);this.lastSave=Date.now(),await s.writeStream(this.model.readWithUnsavedEdits()),this.lastSave=Date.now(),this.model.dispose(),this.model=new _({accessor:s,isFiniteSize:!0,supportsLengthChanges:!0})}async revert(t){this.model.revert(),this._onDidRevert.fire()}async backup(t){return await new M(t).write(this.model.unsavedEdits),{id:t.toString(),delete:async()=>{try{await E.workspace.fs.delete(t)}catch{}}}}static parseHexOrDecInt(t){return t=t.toLowerCase(),t.startsWith("0x")?parseInt(t.substring(2),16):parseInt(t,10)}}});var Pe,kr,Ct,Fe,Pr=v(()=>{"use strict";Pe=Symbol("Wildcard"),kr=new Uint8Array(255);for(let r=0;r<255;r++)kr[r]=r;Ct=new Uint8Array(255);for(let r=0;r<255;r++)Ct[r]=String.fromCharCode(r).toUpperCase().charCodeAt(0);Fe=class{constructor(e,t,i=kr){this.needle=e;this.onMatch=t;this.equivalencyTable=i;this.needleLen=0;this.index=0;this.usableBuffer=0;for(let s of e)s===Pe?this.needleLen++:this.needleLen+=s.length;this.buffer=new Uint8Array(this.needleLen)}push(e){let{needleLen:t,buffer:i}=this;for(let s=0;s<e.length;s++)i[this.index++%t]=e[s],this.usableBuffer++,this.attemptMatch()}attemptMatch(){let{needle:e,needleLen:t,buffer:i,index:s,equivalencyTable:o}=this;if(this.usableBuffer<t)return;let n=0;for(let c=0;c<e.length;c++){let l=e[c];if(l===Pe){n++;continue}for(let f=0;f<l.length;f++){if(o[l[f]]!==o[i[(s+n)%t]])return;n++}}this.matchTmpBuf||(this.matchTmpBuf=new Uint8Array(t));let a=this.index%t;this.matchTmpBuf.set(i.subarray(a),0),this.matchTmpBuf.set(i.subarray(0,a),t-a),this.onMatch(this.index-t,this.matchTmpBuf),this.usableBuffer=0}}});var qe,H,bs,Y,Fr=v(()=>{"use strict";Tt();Pr();qe=class r{constructor(e,t){this.filesize=e;this.cap=t;this.buffers=new W;this.fileOffset=0;this.lastYieldedTime=Date.now();this.results=[]}static{this.targetUpdateInterval=1e3}get capped(){return this.cap===0}push(e,t,i){let s=this.buffers.set(e,()=>new Uint8Array(e));this.cap===void 0?this.results.push({from:t,to:i,previous:s}):this.cap>0&&(this.results.push({from:t,to:i,previous:s}),this.cap--)}toYield(){let e=Date.now();if(e-this.lastYieldedTime>r.targetUpdateInterval){this.lastYieldedTime=e;let t=this.results;return this.results=[],{progress:this.filesize?this.fileOffset/this.filesize:0,results:t}}}final(){return{progress:1,capped:this.capped,results:this.results}}},H=class{constructor(e,t,i,s){this.document=e;this.query=t;this.isCaseSensitive=i;this.cap=s;this.cancelled=!1}dispose(){this.cancelled=!0}async*search(){let{isCaseSensitive:e,query:t,document:i,cap:s}=this,o=new qe(await i.size(),s),n=new Fe(t.literal.map(a=>a==="*"?Pe:a),(a,c)=>o.push(c,a,a+c.length),e?void 0:Ct);for await(let a of i.readWithUnsavedEdits(0)){if(this.cancelled||o.capped){yield o.final();return}n.push(a),o.fileOffset+=a.length;let c=o.toYield();c&&(yield c)}yield o.final()}},bs=8*1024,Y=class{constructor(e,t,i,s){this.document=e;this.cap=s;this.cancelled=!1;this.re=new RegExp(t.re,i?"g":"ig")}dispose(){this.cancelled=!0}async*search(){let e="",t=0,{re:i,document:s}=this,o=new TextDecoder("ascii"),n=new TextEncoder,a=new qe(await s.size(),this.cap);for await(let c of s.readWithUnsavedEdits(0)){if(this.cancelled||a.capped){yield a.final();return}e+=o.decode(c);let l=0;for(let b of e.matchAll(i)){let X=t+e.slice(0,b.index).length,Me=b[0].length;a.push(n.encode(b[0]),X,X+Me),l=b.index+b[0].length}a.fileOffset+=c.length;let f=Math.max(e.length-bs,l);f>0&&(t+=f,i.lastIndex=0,e=e.slice(f));let p=a.toYield();p&&(yield p)}yield a.final()}}});var gs={};var qr,Mr=v(()=>{"use strict";qr=require("chai");L();Cr();Fr();Ie();describe("searchRequest",async()=>{let r=`Esse in aliqua minim magna dolor tempor eiusmod exercitation ullamco veniam nisi ipsum cillum commodo. Velit ad aliquip dolor sint anim consequat. Excepteur culpa non adipisicing elit tempor laborum tempor qui. Do esse dolore incididunt consequat non excepteur fugiat fugiat veniam deserunt ut pariatur eiusmod. Deserunt irure qui cupidatat laboris.

Irure nulla nulla consequat reprehenderit nisi nulla consequat dolor. Ad consectetur cillum consectetur ea. Reprehenderit esse in in anim mollit laboris eiusmod. Pariatur enim ipsum dolor eiusmod laboris mollit aliqua ullamco laborum fugiat non et. Officia adipisicing duis id sit aliqua et et occaecat. Commodo Lorem laborum aliquip officia ex quis elit elit do qui consectetur dolore.

Lorem ad ullamco ad deserunt voluptate ullamco et in commodo et exercitation duis nisi. Reprehenderit deserunt deserunt eiusmod velit mollit cillum pariatur Lorem exercitation laboris non. Ad eiusmod mollit reprehenderit amet ex elit deserunt cupidatat ullamco ullamco consectetur elit. Laboris duis cupidatat ipsum id anim occaecat pariatur.`,e=async(n,a)=>{let c;for await(let f of n.search())c=f.results.map(p=>({from:p.from,to:p.to,previous:p.previous}));if(!c)throw new Error("no result");let l=f=>f.sort((p,b)=>p.from-b.from).map(p=>({...p,previous:new TextDecoder().decode(p.previous)}));(0,qr.expect)(l(c)).to.deep.equal(l(a))},t="laboris",i=new TextEncoder().encode(t),s=[{from:341,previous:i,to:348},{from:496,previous:i,to:503},{from:547,previous:i,to:554},{from:915,previous:i,to:922}],o=async(n=r)=>new ke(new _({accessor:await Ue(new TextEncoder().encode(n)),supportsLengthChanges:!1,isFiniteSize:!0}),!1,0);it("searches for literal",async()=>{let n=await o();await e(new H(n,{literal:[i]},!0,void 0),s)}),it("searches for literal in an edited document",async()=>{let n=await o(),a=[...s,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033},{from:1081,previous:new TextEncoder().encode("Laboris"),to:1088},{from:1088,previous:new TextEncoder().encode("Laboris"),to:1095},{from:1095,previous:new TextEncoder().encode("Laboris"),to:1102}];n.makeEdits(new Array(3).fill({op:0,offset:r.length,value:new TextEncoder().encode("Laboris")})),await e(new H(n,{literal:[i]},!1,void 0),a),await n.save(),await e(new H(n,{literal:[i]},!1,void 0),a)}),it("searches for literal case insensitive",async()=>{let n=await o();await e(new H(n,{literal:[i]},!1,void 0),[...s,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])}),it("searches for regex",async()=>{let n=await o();await e(new Y(n,{re:t},!0,void 0),s)}),it("searches for regex case insensitive",async()=>{let n=await o();await e(new Y(n,{re:t},!1,void 0),[...s,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])})})});function T(r){let e=[],t=new Set(r),i=new Set,s=-1;for(;t.size||i.size;){let o;for(let a of t)(!o||o.start>a.start)&&(o=a);let n;for(let a of i)(!n||n.end>a.end)&&(n=a);o&&(!n||o.start<n.end)?(s!==-1&&i.size&&i.size%2===1&&s!==o.start&&e.push(new u(s,o.start)),s=o.start,i.add(o),t.delete(o)):n&&(i.size%2===1&&s!==n.end&&e.push(new u(s,n.end)),s=n.end,i.delete(n))}return e}var u,Hr=v(()=>{"use strict";u=class r{constructor(e,t=Number.MAX_SAFE_INTEGER,i){this.start=e;this.end=t;if(e<0)throw new Error("Cannot construct a range with a negative start");t<e?([this.start,this.end]=[t,e],i??=1):i??=0,this.direction=i}get size(){return this.end-this.start}static single(e){return new r(e,e+1)}static inclusive(e,t){return t>=e?new r(e,t+1):new r(e+1,t)}includes(e){return e>=this.start&&e<this.end}expandToContain(e){return e<this.start?new r(e,this.end,this.direction):e>=this.end?new r(this.start,e+1,this.direction):this}overlaps(e){return e.end>this.start&&e.start<this.end}difference(e){if(!this.overlaps(e))return[this,e];let t=[];return this.start!==e.start&&t.push(new r(e.start,this.start)),this.end!==e.end&&t.push(new r(e.end,this.end)),t}}});var ws={};var C,Br=v(()=>{"use strict";C=require("chai");Hr();describe("Range",()=>{describe("getRangeSelectionsFromStack",()=>{it("works for a single",()=>{(0,C.expect)(T([new u(10,20)])).to.deep.equal([new u(10,20)])}),it("works for non-overlapping",()=>{(0,C.expect)(T([new u(10,20),new u(30,40)])).to.deep.equal([new u(10,20),new u(30,40)])}),it("excludes overlapping",()=>{(0,C.expect)(T([new u(10,20),new u(30,40),new u(15,35)])).to.deep.equal([new u(10,15),new u(20,30),new u(35,40)])}),it("excludes identity",()=>{(0,C.expect)(T([new u(10,20),new u(10,20)])).to.deep.equal([])}),it("includes identity",()=>{(0,C.expect)(T([new u(10,20),new u(10,20),new u(10,20)])).to.deep.equal([new u(10,20)])}),it("pyramid#1",()=>{(0,C.expect)(T([new u(0,100),new u(10,90),new u(20,80),new u(30,70),new u(40,60)])).to.deep.equal([new u(0,10),new u(20,30),new u(40,60),new u(70,80),new u(90,100)])}),it("pyramid#2",()=>{(0,C.expect)(T([new u(0,50),new u(10,60),new u(20,70),new u(30,80)])).to.deep.equal([new u(0,10),new u(20,30),new u(50,60),new u(70,80)])})})})});var Ss={};Nr(Ss,{run:()=>Es});module.exports=Qr(Ss);var Z=k(require("mocha")),xs=[()=>Promise.resolve().then(()=>(wr(),ps)),()=>Promise.resolve().then(()=>(Dr(),ys)),()=>Promise.resolve().then(()=>(Mr(),gs)),()=>Promise.resolve().then(()=>(Br(),ws))];async function Es(){let r=new Z.default({ui:"bdd",color:!0});for(let e of xs)r.suite.emit(Z.default.Suite.constants.EVENT_FILE_PRE_REQUIRE,global,e,r),await e(),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_REQUIRE,{},e,r),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_POST_REQUIRE,global,e,r);return new Promise((e,t)=>{r.run(i=>{i>0?t(new Error(`${i} tests failed.`)):e()})})}0&&(module.exports={run});
